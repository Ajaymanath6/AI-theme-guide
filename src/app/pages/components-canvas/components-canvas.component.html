<div class="min-h-screen bg-brandcolor-fill p-4">
  <!-- Save to Project Button (OUTSIDE canvas) -->
  <div class="mb-4 flex justify-end">
    <button (click)="exportCatalog()"
            class="flex items-center gap-2 px-4 py-2 bg-brandcolor-primary text-white rounded-lg hover:bg-brandcolor-primaryhover transition-colors shadow-md"
            title="ðŸ’¡ Saves directly to your project folder (first time: select folder)">
      <span class="material-symbols-outlined" style="font-size: 20px;">save</span>
      <span class="text-sm font-medium">Save to Project</span>
    </button>
  </div>
  
  <!-- Canvas Area -->
  <div class="relative bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg overflow-hidden canvas-container h-[calc(100vh-2rem)]">
      <!-- Canvas Elements -->
      @for (element of canvasElements; track element.id) {
        <div
          cdkDrag
          [attr.data-element-id]="element.id"
          (cdkDragStarted)="onDragStarted(element)"
          (cdkDragMoved)="onDragMoved($event, element)"
          (cdkDragEnded)="onDragEnded($event, element)"
          [style.position]="'absolute'"
          [style.left.px]="element.x"
          [style.top.px]="element.y"
          [style.cursor]="'move'"
          [style.z-index]="'1'"
          class="cursor-move draggable-element component-wrapper"
          [class.shared-component]="element.isSharedComponent">
          
          <!-- Header Component -->
          @if (element.type === 'header') {
            <header title="header" class="bg-brandcolor-textstrong border-b border-brandcolor-strokeweak rounded-lg shadow-lg">
              <div class="flex items-center justify-between px-4 py-[14px] min-w-[600px]">
                <!-- Logo -->
                <a routerLink="/projects" class="flex items-center cursor-pointer">
                  <img src="/logo-main.svg" alt="Logo" class="h-8">
                </a>

                <!-- Right Side Options -->
                <div class="flex items-center gap-4">
                  <!-- Option 1 -->
                  <button
                    type="button"
                    class="flex items-center gap-2 px-3 py-2 text-brandcolor-white hover:bg-brandcolor-sidebarhover rounded-lg transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 20px;">settings</span>
                    <span class="text-sm font-medium">Settings</span>
                  </button>

                  <!-- Option 2 -->
                  <button
                    type="button"
                    class="flex items-center gap-2 px-3 py-2 text-brandcolor-white hover:bg-brandcolor-sidebarhover rounded-lg transition-colors">
                    <span class="material-symbols-outlined" style="font-size: 20px;">help_outline</span>
                    <span class="text-sm font-medium">Help</span>
                  </button>
                </div>
              </div>
            </header>
          }
          
          <!-- Card 1: Long Paragraph with Primary and Secondary Buttons -->
          @if (element.type === 'card1') {
            <div title="card1" class="bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg p-6 w-full max-w-sm shadow-lg">
              <h3 class="text-brandcolor-textstrong font-semibold text-xl mb-1">Card Title One</h3>
              <p class="text-brandcolor-textweak text-sm mb-4">Card Subtitle One</p>
              <hr class="border-brandcolor-strokeweak mb-4">
              <p class="text-brandcolor-textweak text-sm mb-4">
                This is a long paragraph that contains multiple sentences to demonstrate how text content can span across several lines within a card component. It provides enough content to show how the card handles longer text blocks and ensures proper spacing and readability.
              </p>
              <div class="flex gap-3">
                <button
                  type="button"
                  title="card1-primary-button"
                  class="border-[1.5px] border-transparent bg-brandcolor-primary text-brandcolor-white hover:bg-brandcolor-primaryhover focus:border-brandcolor-primary active:border-brandcolor-primary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium shadow-lg">
                  Primary
                </button>
                <button
                  type="button"
                  title="card1-secondary-button"
                  class="border-[1.5px] border-brandcolor-secondary bg-brandcolor-secondary text-brandcolor-white hover:bg-brandcolor-secondaryhover focus:border-brandcolor-secondary active:border-brandcolor-secondary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium shadow-lg">
                  Secondary
                </button>
              </div>
            </div>
          }
          
          <!-- Card 2: Two Lines with Primary and Primary Outline Buttons -->
          @if (element.type === 'card2') {
            <div title="card2" class="bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg p-6 w-full max-w-sm shadow-lg">
              <h3 class="text-brandcolor-textstrong font-semibold text-xl mb-1">Card Title Two</h3>
              <p class="text-brandcolor-textweak text-sm mb-4">Card Subtitle Two</p>
              <hr class="border-brandcolor-strokeweak mb-4">
              <p class="text-brandcolor-textweak text-sm mb-4">
                This is a two-line paragraph that demonstrates how shorter content looks within the card component. It spans exactly two lines.
              </p>
              <div class="flex gap-3">
                <button
                  type="button"
                  title="card2-primary-button"
                  class="border-[1.5px] border-transparent bg-brandcolor-primary text-brandcolor-white hover:bg-brandcolor-primaryhover focus:border-brandcolor-primary active:border-brandcolor-primary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium shadow-lg">
                  Primary
                </button>
                <button
                  type="button"
                  title="card2-primary-outline-button"
                  class="border-[1.5px] border-brandcolor-primary bg-transparent text-brandcolor-primary hover:bg-brandcolor-neutralhover focus:border-brandcolor-primary active:border-brandcolor-primary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium">
                  Primary Outline
                </button>
              </div>
            </div>
          }
          
          <!-- Card 3: One Line with Secondary and Secondary Outline Buttons -->
          @if (element.type === 'card3') {
            @if (element.isSharedComponent) {
              <!-- Shared Component: Show component tag -->
              <app-card3></app-card3>
            } @else {
              <!-- Not Shared: Show full HTML -->
              <div title="card3" class="bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg p-6 w-full max-w-sm shadow-lg">
                <h3 class="text-brandcolor-textstrong font-semibold text-xl mb-1">Card Title Three</h3>
                <p class="text-brandcolor-textweak text-sm mb-4">Card Subtitle Three</p>
                <hr class="border-brandcolor-strokeweak mb-4">
                <p class="text-brandcolor-textweak text-sm mb-4">
                  This is a single line of text content.
                </p>
                <div class="flex gap-3">
                  <button
                    type="button"
                    title="card3-secondary-button"
                    class="border-[1.5px] border-brandcolor-secondary bg-brandcolor-secondary text-brandcolor-white hover:bg-brandcolor-secondaryhover focus:border-brandcolor-secondary active:border-brandcolor-secondary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium shadow-lg">
                    Secondary
                  </button>
                  <button
                    type="button"
                    title="card3-secondary-outline-button"
                    class="border-[1.5px] border-brandcolor-secondary bg-transparent text-brandcolor-secondary hover:bg-brandcolor-neutralhover focus:border-brandcolor-secondary active:border-brandcolor-secondary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium">
                    Secondary Outline
                  </button>
                </div>
              </div>
            }
          }
          
          <!-- Card 4: Title, Subtitle, Sub Headings (Left & Right), Divider, Primary & Neutral Buttons -->
          @if (element.type === 'card4') {
            <div title="card4" class="bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg p-6 w-full max-w-sm shadow-lg">
              <h3 class="text-brandcolor-textstrong font-semibold text-xl mb-1">Card Title Four</h3>
              <p class="text-brandcolor-textweak text-sm mb-4">Card Subtitle Four</p>
              
              <!-- Sub Headings Left and Right -->
              <div class="flex items-center justify-between mb-4">
                <!-- Left End -->
                <div>
                  <h4 class="text-brandcolor-textstrong font-medium text-sm mb-1">Sub Heading Left</h4>
                  <p class="text-brandcolor-textweak text-xs">Sub Title Left</p>
                </div>
                
                <!-- Right End -->
                <div class="text-right">
                  <h4 class="text-brandcolor-textstrong font-medium text-sm mb-1">Sub Heading Right</h4>
                  <p class="text-brandcolor-textweak text-xs">Sub Title Right</p>
                </div>
              </div>
              
              <!-- Divider -->
              <hr class="border-brandcolor-strokeweak mb-4">
              
              <!-- Buttons -->
              <div class="flex gap-3">
                <button
                  type="button"
                  title="card4-primary-button"
                  class="flex-1 border-[1.5px] border-transparent bg-brandcolor-primary text-brandcolor-white hover:bg-brandcolor-primaryhover focus:border-brandcolor-primary active:border-brandcolor-primary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium shadow-lg">
                  Primary
                </button>
                <button
                  type="button"
                  title="card4-neutral-button"
                  class="flex-1 border-[1.5px] border-brandcolor-strokeweak bg-brandcolor-white text-brandcolor-textstrong hover:bg-brandcolor-neutralhover focus:border-brandcolor-strokeweak active:border-brandcolor-strokeweak active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium">
                  Neutral
                </button>
              </div>
            </div>
          }
          
          <!-- Sidebar Component -->
          @if (element.type === 'sidebar') {
            <app-sidebar
              [isSidebarCollapsed]="isSidebarCollapsed"
              [activeMenuItem]="activeMenuItem"
              [selectedDropdownOption]="selectedDropdownOption"
              [uniqueId]="element.id"
              (sidebarToggle)="toggleSidebar()"
              (menuItemClick)="onMenuItemClick($event)"
              (dropdownOptionSelect)="selectedDropdownOption = $event">
            </app-sidebar>
          }
          
          <!-- Dropdown Component: Header, 5 Options, Divider, and Two Buttons -->
          @if (element.type === 'dropdown') {
            <div title="dropdown" class="bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg p-0 w-full max-w-sm shadow-lg">
              <!-- Dropdown Button -->
              <div class="relative p-4 pb-0">
                <button 
                  title="dropdown-button"
                  [id]="'dropdown-button-' + element.id" 
                  [attr.data-dropdown-toggle]="'dropdown-menu-' + element.id" 
                  type="button" 
                  class="w-full border-[1.5px] border-brandcolor-strokeweak bg-brandcolor-white text-brandcolor-textstrong hover:bg-brandcolor-fill focus:border-brandcolor-primary active:border-brandcolor-primary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium flex items-center justify-between">
                  <span>Select Option</span>
                  <svg class="w-4 h-4 text-brandcolor-strokestrong" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                <!-- Dropdown Menu -->
                <div 
                  [id]="'dropdown-menu-' + element.id" 
                  class="hidden z-50 bg-brandcolor-white border border-brandcolor-strokeweak rounded-lg shadow-lg min-w-full absolute top-12 left-4 right-4">
                  <!-- Header -->
                  <div class="px-4 py-3 border-b border-brandcolor-strokeweak">
                    <h3 class="text-brandcolor-textstrong font-semibold text-sm">Dropdown Header</h3>
                  </div>
                  <!-- Options -->
                  <ul class="py-2 text-sm text-brandcolor-textstrong">
                    <li>
                      <a href="#" title="dropdown-option-1" (click)="onDropdownOption($event, 'option1')" class="flex items-center gap-2 px-4 py-2 hover:bg-brandcolor-fill">
                        <span>Option 1</span>
                      </a>
                    </li>
                    <li>
                      <a href="#" title="dropdown-option-2" (click)="onDropdownOption($event, 'option2')" class="flex items-center gap-2 px-4 py-2 hover:bg-brandcolor-fill">
                        <span>Option 2</span>
                      </a>
                    </li>
                    <li>
                      <a href="#" title="dropdown-option-3" (click)="onDropdownOption($event, 'option3')" class="flex items-center gap-2 px-4 py-2 hover:bg-brandcolor-fill">
                        <span>Option 3</span>
                      </a>
                    </li>
                    <li>
                      <a href="#" title="dropdown-option-4" (click)="onDropdownOption($event, 'option4')" class="flex items-center gap-2 px-4 py-2 hover:bg-brandcolor-fill">
                        <span>Option 4</span>
                      </a>
                    </li>
                    <li>
                      <a href="#" title="dropdown-option-5" (click)="onDropdownOption($event, 'option5')" class="flex items-center gap-2 px-4 py-2 hover:bg-brandcolor-fill">
                        <span>Option 5</span>
                      </a>
                    </li>
                  </ul>
                  <!-- Divider -->
                  <hr class="border-brandcolor-strokeweak">
                  <!-- Action Buttons -->
                  <div class="p-4 flex gap-3">
                    <button
                      type="button"
                      title="dropdown-primary-button"
                      (click)="onDropdownPrimaryButton(element.id)"
                      class="flex-1 border-[1.5px] border-transparent bg-brandcolor-primary text-brandcolor-white hover:bg-brandcolor-primaryhover focus:border-brandcolor-primary active:border-brandcolor-primary active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium shadow-lg">
                      Primary
                    </button>
                    <button
                      type="button"
                      title="dropdown-neutral-button"
                      (click)="onDropdownNeutralButton(element.id)"
                      class="flex-1 border-[1.5px] border-brandcolor-strokeweak bg-brandcolor-white text-brandcolor-textstrong hover:bg-brandcolor-neutralhover focus:border-brandcolor-strokeweak active:border-brandcolor-strokeweak active:shadow-button-press disabled:opacity-50 rounded-md px-4 py-2 font-medium">
                      Neutral
                    </button>
                  </div>
                </div>
              </div>
            </div>
          }
          
          <!-- Universal Tooltip (works for ALL components) -->
          <div class="component-tooltip flex flex-col gap-2 bg-white/95 backdrop-blur-sm shadow-lg rounded-lg px-3 py-2 border border-gray-200">
            <!-- Row 1: Component ID with actions -->
            <div class="flex items-center gap-2">
              <span class="text-xs font-mono text-gray-700 font-medium">
                {{ element.type }}
                @if (element.isSharedComponent) {
                  <span class="ml-1 text-xs text-blue-600">(shared)</span>
                }
              </span>
              <button (click)="copyToClipboard(element.type); $event.stopPropagation()"
                      class="p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors"
                      title="Copy component ID">
                <span class="material-symbols-outlined" style="font-size: 18px;">content_copy</span>
              </button>
              @if (!isInCatalog(element.type)) {
                <button (click)="addToCatalog(element.type); $event.stopPropagation()"
                        class="p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors"
                        title="Register to catalog">
                  <span class="material-symbols-outlined" style="font-size: 18px;">add_circle_outline</span>
                </button>
              }
              @if (isInCatalog(element.type)) {
                <span class="p-1 text-green-600" title="Registered">
                  <span class="material-symbols-outlined" style="font-size: 18px;">check_circle</span>
                </span>
                <button (click)="removeFromCatalog(element.type); $event.stopPropagation()"
                        class="p-1 text-gray-600 hover:text-red-600 hover:bg-gray-100 rounded transition-colors"
                        title="Remove from catalog">
                  <span class="material-symbols-outlined" style="font-size: 18px;">delete_outline</span>
                </button>
              }
              @if (!element.isSharedComponent) {
                <button (click)="makeSharedComponent(element.type); $event.stopPropagation()"
                        class="p-1 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded transition-colors"
                        title="Make shared component">
                  <span class="material-symbols-outlined" style="font-size: 18px;">share</span>
                </button>
              }
              @if (element.isSharedComponent) {
                <span class="p-1 text-blue-600" title="Shared component">
                  <span class="material-symbols-outlined" style="font-size: 18px;">check_circle</span>
                </span>
              }
            </div>
            
            <!-- Row 2: Component tag (only for shared components) -->
            @if (element.isSharedComponent) {
              <div class="flex items-center gap-2 pt-1 border-t border-gray-200">
                <span class="text-xs font-mono text-blue-600 font-medium">
                  &lt;app-{{ element.type }}&gt;&lt;/app-{{ element.type }}&gt;
                </span>
                <button (click)="copyComponentTag(element.type); $event.stopPropagation()"
                        class="p-1 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded transition-colors"
                        title="Copy component tag">
                  <span class="material-symbols-outlined" style="font-size: 18px;">content_copy</span>
                </button>
              </div>
            }
          </div>
        </div>
      }
      
      <!-- Empty Canvas Message -->
      @if (canvasElements.length === 0) {
        <div class="absolute inset-0 flex items-center justify-center">
          <p class="text-brandcolor-textweak">Drag elements around the canvas</p>
        </div>
      }
  </div>

  <!-- Shared Component Creation Popover -->
  @if (showSharedComponentPopover && selectedComponentForSharing) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center"
         (click)="cancelSharedComponentCreation()">
      <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4"
           (click)="$event.stopPropagation()">
        <!-- Header -->
        <div class="flex items-center gap-3 mb-4">
          <span class="material-symbols-outlined text-blue-600" style="font-size: 32px;">share</span>
          <h2 class="text-xl font-semibold text-brandcolor-textstrong">Make Shared Component</h2>
        </div>

        <!-- Component Info -->
        <div class="mb-6">
          <p class="text-brandcolor-textweak mb-3">
            Convert <span class="font-mono text-blue-600">{{ selectedComponentForSharing }}</span> into a reusable Angular component?
          </p>
          
          <!-- Files that will be created -->
          <div class="bg-brandcolor-fill rounded-lg p-4 mb-4">
            <p class="text-xs font-semibold text-brandcolor-textweak mb-2">This will create:</p>
            <ul class="space-y-1 text-sm text-brandcolor-textstrong font-mono">
              <li>âœ“ {{ selectedComponentForSharing }}.component.ts</li>
              <li>âœ“ {{ selectedComponentForSharing }}.component.html</li>
              <li>âœ“ {{ selectedComponentForSharing }}.component.scss</li>
            </ul>
          </div>

          <!-- CLI Command -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <p class="text-xs font-semibold text-blue-900 mb-2">CLI Command:</p>
            <code class="text-xs text-blue-700 font-mono break-all">
              ng generate component components/{{ selectedComponentForSharing }} --skip-tests
            </code>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
          <button (click)="cancelSharedComponentCreation()"
                  [disabled]="isCreatingComponent"
                  class="flex-1 px-4 py-2 border border-brandcolor-strokeweak text-brandcolor-textstrong rounded-lg hover:bg-brandcolor-fill transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Cancel
          </button>
          <button (click)="confirmCreateSharedComponent()"
                  [disabled]="isCreatingComponent"
                  class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
            @if (isCreatingComponent) {
              <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Creating...</span>
            } @else {
              <span>Create Component</span>
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
